#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'konstant'

unless Konstant.env == "production"
  require "debugger"
end

cli = Konstant::Cli.new
cli.parse_options
command = cli.cli_arguments.first

[:INT, :TERM].each do |sig|
  trap sig do
    Konstant.logger.info "shutting down ..."
    Konstant.shutdown_handlers.each do |sh|
      sh.call
    end
  end
end

case command
  when "run"
    Konstant.configure JSON.parse(File.read "./konstant.js")

    require "puma"
    require "rack/handler/puma"

    threads = []

    if cli.config[:web]
      threads << Thread.new do
        options = {
          :Host => cli.config[:host],
          :Port => cli.config[:port]
        }

        Rack::Handler::Puma.run Konstant::Web, options do |server|
          Konstant.shutdown_handlers << Proc.new do
            server.stop
          end
        end
      end
    end

    if cli.config[:scheduler]
      threads << Thread.new do
        Konstant::Scheduler.new.run
      end
    end

    threads.map{|t| t.join}
  when "config"
    Konstant.configure JSON.parse(File.read "./konstant.js")
    p Konstant.config
  when "generate"
    item = cli.cli_arguments[1]

    case item
      when "project"
        Konstant.configure JSON.parse(File.read "./konstant.js")
        system "cp -a #{Konstant.root}/data/templates/project #{Konstant.config['data_dir']}/projects/#{cli.config[:name]}"
      when "data_dir"
        if target = cli.cli_arguments[2]
          system "cp -a #{Konstant.root}/data/templates/data_dir #{target}"
        else
          puts "Please specify a target"
        end
      else
        puts "Generator doesn't exist: '#{item}'"
    end
  else
    raise "unknown command '#{command}'"
end